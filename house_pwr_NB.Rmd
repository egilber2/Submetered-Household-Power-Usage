---
title: "Household Electric Power Consumption"
output: 
  html_notebook:
    highlight: tango
    theme: spacelab
    toc: yes
    toc_float: yes
    toc_depth: 4
---

```{r setup, include=FALSE }
knitr::opts_chunk$set(echo = TRUE, tidy=TRUE)
```
## Introduction
This project was done as part of a data science program that utilized a story-centered curriculum.  For this project, the student assumes the role of a data scientist working for a data analytics consulting firm whose client is a home developer.  The client would like to know if insights can be found in the sub-metered energy consumption data set that could be used as an incentive to potential home buyers that may be interested in a "smart home."  
The initial task for this project is to frame the problem.  The client's request is purposefully vague so much thought needs to go into defining the busisness problem and converting it into a data science problem.  This is followed by a clear explanation of the data science process to be followed for this project so the client what the deliverables are and how they were arrived at.  

##1 Frame the Problem
The high level business objective is:

Determine if the installation of sub-metering devicese that measure power consumption can translate into economic incentive recommendations for homeowners.  

Information that could be potentially valuable to a homeowner would include:

I.  Sub-metered energy consumption data that provides enough granularity to uncover trends in behavior.  

II. Longer-term patterns of energy usage that can be used to predict future usage with the potential to flag appliance degradation or unusual energy consumption.

III. Identification of peak energy usage can be identified allowing for the potential to modify behavior to take advantage of off-peak electricity rates. 


##2. Collect/Load Raw Data
Load packages.
```{r message=FALSE, warning=FALSE}

library(caret)      #R modeling workhorse & ggplot2
library(tidyverse)  #Package for tidying datalibrary(magrittr)   #Enables piping
library(lubridate)  #Simplifies working with dates/times of a time series
library(VIM)        #Aids visualization and imputing of missing values
library(Hmisc)      #for descriptive statistics
library(GGally)     #ggcorr provides pretty cor plot
library(scales)
library(forecast)   #forcasting package

```

Import the data.
```{r message=FALSE, cache=TRUE, results='hide'}
house_pwr <- read_delim('household_power_consumption.txt', col_names = TRUE, col_types = cols(Global_active_power='d', Global_reactive_power='d',
Voltage='d', Global_intensity='d', Sub_metering_1='d', Sub_metering_2='d', Sub_metering_3='d'), delim=';',  na='?')
```

```{r}
summary(house_pwr)
head(house_pwr)

```
A quick inspection of the data tells us that there are 2,075,259 observations taken at 1 minute intervals. The 9 variables include the 3 sub-meters, a date feature, and a time feature. The features are defined in the table below. 

```{r echo=FALSE}
def_table <- read.csv('Energy_submeter_defs.csv')
knitr::kable(def_table, col.names=c('Feature', 'Definition', 'Sub-Meter-Coverage'), caption='Data Set Feature Definitions')
```  
##3 Process the Data

###3.1 Process Date and Time Features
A new column called DateTime is created by uniting the Date and Time columns.  This is then converted to a POSIXct data type.  

```{r cache=TRUE}
house_pwr <- unite(house_pwr,Date, Time, col='DateTime', sep=' ')

house_pwr$DateTime <- as.POSIXct(house_pwr$DateTime, format="%d/%m/%Y %H:%M:%S", tz="GMT")
class(house_pwr$DateTime)
```
Now that the DateTime feature has been created in the proper format, we can assess the timeframe that the data set covers
```{r}
range(house_pwr$DateTime)
```
So the data set contains energy measurements starting on Dec 16, 2006 and ending on Nov.26, 2010. 
Since 2006 contains only two weeks of data, the data set is filtered to remove data for 2006.

```{r}
house_pwr <- filter(house_pwr, year(DateTime) != 2006)
```


###3.2 Rename Independent Variables
```{r}
colnames(house_pwr)[2] <- 'Glbl_actvPwr'
colnames(house_pwr)[3] <- 'Glbl_ractvPwr'
colnames(house_pwr)[6] <- 'Sub-Meter-1'
colnames(house_pwr)[7] <- 'Sub-Meter-2'
colnames(house_pwr)[8] <- 'Sub-Meter-3'

```
###3.3 Assess Missing Values
The aggr function of the VIM package is used to visualize the extent of missing values in the data set.  
```{r cache=TRUE}
aggr_plot <- aggr(house_pwr, col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE, labels=names(house_pwr),cex.axis=.7,
  gap=3, ylab=c("Histogram of missing data","Pattern"), digits=2)

housePWR_NA <- house_pwr[rowSums(is.na(house_pwr))>0,]
```
Approximately 1.25% of the observations are missing all data except for the DateTime.  These will be removed from the data set.
```{r}
# Remove rows with NA's
house_pwr <- na.omit(house_pwr)
sum(is.na(house_pwr))
```
###3.4 Create a Long Form of Data Set
To aid visualizations in the exploratory data analysis, the gather function is used to create a new feature named Meter which combines the 3 sub-meters.  The values for the sub-meters are put in the newly-created Watt_hr feature.

```{r}
house_pwr_tidy <- house_pwr %>%
  gather(Meter, Watt_hr, `Sub-Meter-1`, `Sub-Meter-2`, `Sub-Meter-3`)  
```
The Meter feature is converted to a factor and the data types are checked with the glimpse function to ensure everything is as it should be before moving on to exploratory data analysis.

```{r}
house_pwr_tidy$Meter <- factor(house_pwr_tidy$Meter)
glimpse(house_pwr_tidy)
```

##4 Explore the Data
###4.1 Visualizations of Energy Usage Across Sub-Meters and Time Periods
Keeping the business objective in mind, the initial exploratory analysis should look for any trends or patterns in the data.  Without trends or patterns in the data, it would be unlikely that any actionalble insights could be delivered to the client.  Insights gained from this initial analysis would be shared with the client to better define or expand the business objective for the project.  

Since this is a large data set and there are quite a few visualizations to generate, the data will be subset and visualized without saving to a dataframe.  This is accomplished using the pipe operator (%>%).  Once the more informative time periods are identified, dataframes of subset time periods can be generated for the more in-depth time series analysis.

####4.1.1 Yearly Time Period
Having observed earlier that only the final two weeks of data were available for 2006, the data will be subset for data from 2007-2010. Also, since data from year 2010 stopped in November, a proportion plot will be used to allow for fairer comparisons between years. 
```{r cache=TRUE}
##-Year_Proportional Plot
house_pwr_tidy %>%
  #filter(year(DateTime)>2006) %>%
  group_by(year(DateTime), Meter) %>%
  summarise(sum=sum(Watt_hr)) %>%
  ggplot(aes(x=factor(`year(DateTime)`), sum, group=Meter,fill=Meter)) +
  labs(x='Year', y='Proportion of Energy Useage') +
  ggtitle('Proportion of Total Yearly Energy Consumption') +
  geom_bar(stat='identity', position='fill', color='black')
```
Of note from the yearly proportion plot is that there is a clear trend of increasing energy consumption on sub-meter-3 (electric water heater/ air conditioner).  A trend such as this could indicate erosion of performance of the air conditioner which would have to run longer and/or more frequently to maintain a termperature set point.  A high level recommendation to the client would be to provide the ability to overlay an average temperature line plot to help the homeowner put heating/cooling energy consumption in context.  In addtion, since sub-meter 3 accounts for the majority of the sub-metered energy consumption, a homeowner would likely find value in knowing how the water heater and air conditioner contribute to that total.  This would require a separate sub-meter for high energy consuming appliances.

####4.1.2 Quarterly Time Period
Looking at total energy consumption by quarter over the 2007-2009 timeframe shows a clear trend of decreasing energy usage with a trough in Q3 and rebounding in Q4. 


```{r cached = TRUE}
#Quarter bar  plot
house_pwr_tidy %>%
  #filter(year(DateTime)>2006) %>%
  filter(year(DateTime)<2010) %>%
  #mutate(quarter=quarter(DateTime)) %>%
  group_by(quarter(DateTime), Meter) %>%
  summarise(sum=round(sum(Watt_hr/1000),3)) %>%
  ggplot(aes(x=factor(`quarter(DateTime)`), y=sum)) +
  labs(x='Quarter of the Year', y='kWh') +
  ggtitle('Total Quarterly Energy Consumption') +
  geom_bar(stat='identity', aes(fill = Meter), color='black')
```

####4.1.3 Monthly Time Period

The same trough of energy consumption observed in the quarterly data is observed with more granularity with aggregated monthly data.  


```{r echo=TRUE, cached=TRUE}
###-Month bar chart
house_pwr_tidy %>%
  #filter(year(DateTime)>2006) %>%
  filter(year(DateTime)<2010) %>%
  mutate(Month=lubridate::month(DateTime, label=TRUE, abbr=TRUE)) %>%
  group_by(Month, Meter) %>%
  summarise(sum=round(sum(Watt_hr)/1000),3) %>%
  ggplot(aes(x=factor(Month), y=sum)) +
    labs(x='Month of the Year', y='kWh') +
    ggtitle('Total Energy Useage by Month of the Year') +
    geom_bar(stat='identity', aes(fill = Meter), colour='black')
```


####4.1.4 Week of the Year Time Period
Additional patterns of energy consumption become apparent when looking at energy usage by week of the year.  In addition to the trough in the summer months, a recurring pattern of noticeably lower energy consumption occurs roughly every 8 or 9 weeks starting with week 1.

```{r cached=TRUE}
#Week of the year- bar plot
house_pwr_tidy %>%
  #filter(year(DateTime)>2006) %>%
  #filter(year(DateTime)<2010) %>%
  group_by(week(DateTime), Meter) %>%
  summarise(sum=sum(Watt_hr/1000)) %>%
  ggplot(aes(x=factor(`week(DateTime)`), y=sum)) +
    labs(x='Week of the Year', y='kWh') +
    ggtitle('Total Energy Usage by Week of the Year') +
    theme(axis.text.x = element_text(angle=90)) +
    geom_bar(stat='identity', aes(fill=Meter), colour='black')

```

####4.1.5 Day of the Week for Low consumption Time Period
Insights gleaned from energy consumption by day of the week could be of value to a homeowner as it can readily be related to homeowner energy consumption behaviors.  This in turn provides potential opportunities for behavior modification.

```{r cached=TRUE}
###-Day of Week bar chart
house_pwr_tidy %>%
  #filter(year(DateTime)>2006) %>%
  filter(week(DateTime) == c(1:8)) %>%
  mutate(Day=lubridate::wday(DateTime, label=TRUE, abbr=TRUE)) %>%
  group_by(Day, Meter) %>%
  summarise(sum=sum(Watt_hr/1000)) %>%
  ggplot(aes(x=factor(Day), y=sum)) +
  labs(x='Day of the Week', y='kWh') +
  ylim(0,85) +
  ggtitle('Total Energy Useage by Day for Weeks of High Consumption') +
  geom_bar(stat='identity', aes(fill = Meter), colour='black')

```
```{r}
house_pwr_tidy %>%
  #filter(year(DateTime)>2006) %>%
  filter(week(DateTime) == c(27:35)) %>%
  mutate(Day=lubridate::wday(DateTime, label=TRUE, abbr=TRUE)) %>%
  group_by(Day, Meter) %>%
  summarise(sum=sum(Watt_hr/1000)) %>%
  ggplot(aes(x=factor(Day), y=sum)) +
  labs(x='Day of the Week', y='kWh') +
  ylim(0,85) +
  ggtitle('Total Energy Useage by Day for Weeks of Low Consumption') +
  geom_bar(stat='identity', aes(fill = Meter), colour='black')
```

There appears to be a trend of increasing energy usage on sub-meter 3 as the week progresses.  Peak laundry days appears to be on Sunday and Wednesday (sub-meter 2), while peak kitchen usage seems to happen on the weekends (sub-meter 1).  
This data is a summary of all years through all weather seasons.  A homeowner may find the information more actionable if the data was subset say,  by seasons.  As an example, trends in energy consumption by day of the week in the winter months will be analyzed.



####4.1.7 Hour of the Day Time Period
Finally, drilling down to the hour of the day shows clear trends in energy consumption.  The lowest energy usage is not suprisingly in the early morning hours where all sub-meters reach their minimum.  If it is determined that the local electricity provider offers off-peak rates, this chart would identify opportunities for the homeowner to shift energy consumption to off-peak hours.  For example, a timer on the washer machine and/or the dishwasher could be set to run after midnight.


```{r cached=TRUE}
#Hour of day bar chart
house_pwr_tidy %>%
  filter(month(DateTime) == c(1,2,11,12)) %>%
  group_by(hour(DateTime), Meter) %>%
  summarise(sum=round(sum(Watt_hr)/1000),3) %>%
  ggplot(aes(x=factor(`hour(DateTime)`), y=sum)) +
  labs(x='Hour of the Day', y='kWh') +
  ggtitle('Total Energy Useage by Hour of the Day') +
  geom_bar(stat='identity', aes(fill = Meter), colour='black')
```
##5 Subset Data Set by Time Periods of Interest
The initial exploratory data analysis uncovered some interesting energy consumption trends that a homeowner and thus the client would find of value.  To determine how these trends recur over time, the data set will be subset by time frames of interest, converted to a time series, and visualized.

###5.1 Quarterly 
Subset by Quarter
```{r}
housePWR_qtr <- house_pwr %>%
  filter(year(DateTime) > 2006) %>%
  #filter(year(DateTime)<2010) %>%
  group_by(year(DateTime), quarter(DateTime)) %>%
  summarise(Sub_Meter_1=round(sum(`Sub-Meter-1`/1000), 3),
            Sub_Meter_2=round(sum(`Sub-Meter-2`/1000), 3),
            Sub_Meter_3=round(sum(`Sub-Meter-3`/1000), 3),
            first_DateTime = first(DateTime))
```
###5.2 Monthly 
```{r}
housePWR_mnth <- house_pwr %>%
  #filter(year(DateTime) > 2006) %>%
  #filter(year(DateTime)<2011) %>%
  group_by(year(DateTime), month(DateTime)) %>%
  summarise(Sub_Meter_1=round(sum(`Sub-Meter-1`/1000), 3),
            Sub_Meter_2=round(sum(`Sub-Meter-2`/1000), 3),
            Sub_Meter_3=round(sum(`Sub-Meter-3`/1000), 3),
            first_DateTime = first(DateTime))
```
###5.3 Weekly
```{r}
housePWR_wkofYr <- house_pwr %>%
  #filter(year(DateTime)>2006) %>%
  #filter(year(DateTime)<2010) %>%
  mutate(DofWk=lubridate::wday(DateTime, label=TRUE, abbr=TRUE)) %>%
  group_by(year(DateTime),week(DateTime)) %>%
  summarise(Sub_Meter_1=round(sum(`Sub-Meter-1`/1000), 3),
            Sub_Meter_2=round(sum(`Sub-Meter-2`/1000), 3),
            Sub_Meter_3=round(sum(`Sub-Meter-3`/1000), 3),
            first_DateTime = first(DateTime))

```
###5.4 Week of the Year- Summer Months
```{r}
housePWR_smrWk <- house_pwr %>%
  filter(year(DateTime)== c(2007, 2008, 2009, 2010)) %>%
  filter(month(DateTime) == c(5,6,7,8)) %>%
  #filter(year(DateTime) == 2009) %>%
  #filter(year(DateTime)<2010) %>%
  #mutate(DofWk=lubridate::week(DateTime, label=TRUE, abbr=TRUE)) %>%
  group_by(year(DateTime),week(DateTime),day(DateTime)) %>%
  summarise(Sub_Meter_1=round(sum(`Sub-Meter-1`/1000), 3),
            Sub_Meter_2=round(sum(`Sub-Meter-2`/1000), 3),
            Sub_Meter_3=round(sum(`Sub-Meter-3`/1000), 3),
            first_DateTime = first(DateTime))
```

##6 Convert to Time Series and Plot TS
###6.1 Quarterly Time Series

```{r}
housePWR_qtrTS <- ts(housePWR_qtr[,3:5], frequency=4, start=c(2007,1), end=c(2010,3))
plot(housePWR_qtrTS, plot.type='s',
     #xaxt='n',
     #xlim=c(2007, 2010),
     #xaxp=c(2006, 2011, 5),
     col=c('red', 'green', 'blue'),
     main='Total Quarterly kWh Consumption',
     xlab='Year', ylab = 'kWh')
minor.tick(nx=4)
b <- c('Sub-meter-1', 'Sub-meter-2', 'Sub-meter-3')
legend('topleft', b, col=c('red', 'green', 'blue'), lwd=2, bty='n')
```
We can see that the mid-year trough of energy consumption observed in the quarterly bar chart does indeed repeat over the time as shown in the time series plot.  This trend is most-pronounced for sub-meter 3.

###6.2 Monthly Time Series
```{r}
housePWR_mnthTS <- ts(housePWR_mnth[,3:5], frequency = 12, start=c(2007,1), end=c(2010,11))
plot(housePWR_mnthTS, plot.type='s',#xaxt='n',
     #xaxp = c(1,13,12),
     col=c('red', 'green', 'blue'),
     main='Total Monthly kWh Consumption',
     xlab='Year/Month', ylab = 'kWh')
minor.tick(nx=12)
b <- c('Sub-meter-1', 'Sub-meter-2', 'Sub-meter-3')
legend('topleft', b, col=c('red', 'green', 'blue'), lwd=2, bty='n')
```
###6.3 Week of Year Time Series

```{r}
housePWR_wkofYrTS <- ts(housePWR_wkofYr[,3:5], frequency = 53, start=c(2007,2), end=c(2010,48))
plot(housePWR_wkofYrTS, plot.type='s',#xaxt='n',
     #xaxp = c(1,13,12),
     col=c('red', 'green', 'blue'),
     main='Total Monthly kWh Consumption',
     xlab='Year/Month', ylab = 'kWh')
minor.tick(nx=52)
b <- c('Sub-meter-1', 'Sub-meter-2', 'Sub-meter-3')
legend('topleft', b, col=c('red', 'green', 'blue'), lwd=2, bty='n')
```

##7 Forecasts of Energy Consumption_Linear Model
###7.1 Quarterly Forecast
```{r}
fit1 <- tslm(housePWR_qtrTS[,3] ~ trend + season)
x <- forecast(fit1, h=4, level=c(80,95))
plot(x, showgap=FALSE, include=3,
     shadecols=c('slategray3','slategray'),
     xlab='Year', ylab='kWh',
     main='4-Quarter Forecast of Quartlerly Energy Consumption for Submeter-3')
minor.tick(nx=2)
summary(x)
```
```{r}
plot.ts(x=fit1$fitted.values, y=housePWR_qtrTS[,3], xy.lines = FALSE,
        xy.labels = FALSE,
        xlab='Fitted Value',
        ylab='Actual',
        main='Quarterly Predicted vs. Actual Values')
abline(0,1, col='blue')

```

```{r}
plot.ts(x=fit1$fitted.values, y=fit1$residuals, xy.lines=FALSE,
        xy.labels = FALSE,
        xlab='Predicted Value',
        ylab='Residuals',
        main='Quarterly Predicted vs. Residuals')
abline(0,0, lty=2, col='grey')
```

```{r}
qqnorm(fit1$residuals, main='Quarterly Q-Q Plot')
qqline(fit1$residuals)
```
 
```{r}
checkresiduals(fit1)

```
###7.2 Monthly Forecast
```{r}
fit2 <- tslm(housePWR_mnthTS[,3] ~ trend + season)
y <- forecast(fit2,h=12, level=c(80,95))
plot(y, showgap=FALSE, include=5,
  shadecols=c('slategray3','slategray'),
  xlab ='Year',
  ylab=' kWh',
  main='12-Month Forecast of Monthly Energy Consumption')
minor.tick(nx=6)
summary(y)
```
```{r}
plot.ts(x=fit2$fitted.values, y=housePWR_mnthTS[,3], xy.lines = FALSE,
        xy.labels = FALSE,
        xlab='Fitted Value',
        ylab='Actual',
        main='Monthly Predicted vs. Actual Values')
abline(0,1, col='blue')
```

```{r}
plot.ts(x=fit2$fitted.values, y=fit2$residuals, xy.lines=FALSE,
        xy.labels = FALSE,
        xlab='Predicted Value',
        ylab='Residuals',
        main='Monthly Predicted vs. Residuals')
abline(0,0, lty=2, col='grey')
```
```{r}
qqnorm(fit2$residuals, main='Monthly Q-Q Plot')
qqline(fit2$residuals)

```
```{r}
checkresiduals(fit2)

```
```{r}
fit3 <- tslm(housePWR_wkofYrTS[,3] ~ trend + season)
z <- forecast(fit3, level=c(80,95), h=24)
plot(z, showgap=FALSE, include=4,
     shadecols=c('slategray3','slategray'),
     xlab ='Day of Week',
     ylab='kWh',
     main='Forecast of Weekly Energy Consumption on Submeter-3')
```
```{r}
plot.ts(x=fit3$fitted.values, y=housePWR_wkofYrTS[,3], xy.lines = FALSE,
        xy.labels = FALSE,
        xlab='Fitted Value',
        ylab='Actual',
        main='Week of Year Predicted vs. Actual Values')
abline(0,1, col='blue')
```
```{r}
plot.ts(x=fit3$fitted.values, y=fit3$residuals, xy.lines=FALSE,
        xy.labels = FALSE,
        xlab='Predicted Values',
        ylab='Residuals',
        main='Week of Year Predicted vs. Residuals')
abline(0,0, lty=2, col='grey')
```
```{r}
qqnorm(fit3$residuals, main='Weekly Q-Q Plot')
qqline(fit3$residuals)
```
```{r}
checkresiduals(fit3, main='Residuals from Week of Year Linear Regression Model')

```
##8 Holt-Winters Simple Exponential Smoothing Model
###8.1 Quarterly Time Series
```{r}
##-Sub-Meter-3
#-Decompose TS
qtr_decomp3 <- decompose(housePWR_qtrTS[,3])
autoplot(qtr_decomp3,  range.bars = TRUE) +
  xlab('Year') +
  ylab('kWh') +
  ggtitle('Decomposed Quarterly Time Series- Sub-Meter-3')
```
```{r}
#-remove seasonality
qtr_seasonAdj3 <- seasadj(qtr_decomp3)

plot(qtr_seasonAdj3, #xaxt='n',
     col='blue',
     xlab='Year', ylab='kWh',
     #xlim=c(2007, 2010),
     xaxp=c(2006, 2010, 4),
     main='Seasonally Adjusted Quarterly Time Series')
minor.tick(nx=2)
b <-'Sub-meter-3'
legend('topleft', b, col='blue', lwd=2, bty='n')
```

```{r}
#-Fit Holt Winters simple exponetial smoothing model
qtr_smooth3 <- HoltWinters(qtr_seasonAdj3,
                           beta=FALSE,
                           gamma=FALSE)
plot(qtr_smooth3, col='blue', #xaxt='n',
     xlab='Year', ylab = 'kWh',
     xlim=c(2007, 2011),
     xaxp=c(2006, 2010, 4),
     main='Simple Exponential Smoothing Holt-Winters Model for Quarterly Time Series')
minor.tick(nx=4)
legend('topleft', 'Sub-Meter-3', col='blue', lwd=2, bty='n')
```

```{r}
#-Forecast
qtr_smoothFcast3 <- forecast(qtr_smooth3, h=5,level = c(80,95))

summary(qtr_smoothFcast3)
checkresiduals(qtr_smoothFcast3)
plot(qtr_smoothFcast3, include=1,
     #xaxt='n',
     shadecols=c('slategray3','slategray'),
     col='blue',
     #xaxp=c(2010.6,2011.5,4),
     xlab='Year', ylab = 'Wh',
     #xlim=c(2010,2011),
     main='5 Quarter Forecast of Energy Useage on Sub-Meter 3')
#minor.tick(nx=4)
#axis(side=1, at= c(1, 2,3,4,5,6,7,8,9,10,11,12, 13), labels=MonthLst)
legend('topleft', 'Sub-Meter-3', col='blue', lwd=2, bty='n')
```





