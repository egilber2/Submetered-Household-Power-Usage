---
title: "Household Electric Power Consumption"
output: 
  html_notebook:
    highlight: tango
    theme: spacelab
    toc: yes
    toc_float: yes
    toc_depth: 4
---

```{r setup, include=FALSE }
knitr::opts_chunk$set(echo = TRUE, tidy=TRUE)
```
## Introduction
This project was done as part of a data science program that utilized a story-centered curriculum.  For this project, the student assumes the role of a data scientist working for a data analytics consulting firm whose client is a home developer.  The client would like to know if insights can be found in the sub-metered energy consumption data set that could be used as an incentive to potential home buyers that may be interested in a "smart home."  
The initial task for this project is to frame the problem.  The client's request is purposefully vague so much thought needs to go into defining the busisness problem and converting it into a data science problem.  This is followed by a clear explanation of the data science process to be followed for this project so the client what the deliverables are and how they were arrived at.  

##1 Frame the Problem
The high level business objective is:

Determine if the installation of sub-metering devicese that measure power consumption can translate into economic incentive recommendations for homeowners.  

Information that could be potentially valuable to a homeowner would include:

I.  Sub-metered energy consumption data that provides enough granularity to uncover trends in behavior.  

II. Longer-term patterns of energy usage that can be used to predict future usage with the potential to flag appliance degradation or unusual energy consumption.

III. Identification of peak energy usage can be identified allowing for the potential to modify behavior to take advantage of off-peak electricity rates. 


##2. Collect/Load Raw Data
Load packages.
```{r message=FALSE, warning=FALSE}

library(caret)      #R modeling workhorse & ggplot2
library(tidyverse)  #Package for tidying datalibrary(magrittr)   #Enables piping
library(lubridate)  #Simplifies working with dates/times of a time series
library(VIM)        #Aids visualization and imputing of missing values
library(Hmisc)      #for descriptive statistics
library(GGally)     #ggcorr provides pretty cor plot
library(scales)
library(forecast)   #forcasting package

```

Import the data.
```{r message=FALSE, cache=TRUE, results='hide'}
house_pwr <- read_delim('household_power_consumption.txt', col_names = TRUE, col_types = cols(Global_active_power='d', Global_reactive_power='d',
Voltage='d', Global_intensity='d', Sub_metering_1='d', Sub_metering_2='d', Sub_metering_3='d'), delim=';',  na='?')
```

```{r}
# Convert to a tibble
summary(house_pwr)
head(as_tibble(house_pwr))

```
A quick inspection of the data tells us that there are over 2 million observations taken at 1 minute intervals. The 9 variables include the 3 sub-meters, a date feature, and a time feature. The date and time will be combined into a date-time format that's amendable to time series analysis.   
##3 Process the Data

###3.1 Process Date and Time Features
A new column called DateTime is created by uniting the Date and Time columns.  This is then converted to a POSIXct data type.  The time zone was identified in the data repository so EST was chosen by the tz argument.
```{r cache=TRUE}
house_pwr <- unite(house_pwr,Date, Time, col='DateTime', sep=' ')

house_pwr$DateTime <- as.POSIXct(house_pwr$DateTime, format="%d/%m/%Y %H:%M:%S", tz="GMT")
class(house_pwr$DateTime)
```
###3.2 Rename Independent Variables
```{r}
colnames(house_pwr)[2] <- 'Glbl_actvPwr'
colnames(house_pwr)[3] <- 'Glbl_ractvPwr'
colnames(house_pwr)[6] <- 'Sub-Meter-1'
colnames(house_pwr)[7] <- 'Sub-Meter-2'
colnames(house_pwr)[8] <- 'Sub-Meter-3'

```
###3.3 Assess Missing Values
The aggr function of the VIM package is used to visualize the extent of missing values in the data set.  
```{r cache=TRUE}
aggr_plot <- aggr(house_pwr, col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE, labels=names(house_pwr),cex.axis=.7,
  gap=3, ylab=c("Histogram of missing data","Pattern"), digits=2)

housePWR_NA <- house_pwr[rowSums(is.na(house_pwr))>0,]
```
Approximately 1.25% of the observations are missing all data except for the DateTime 
```{r}
# Remove rows with NA's
house_pwr <- na.omit(house_pwr)
sum(is.na(house_pwr))
```
###3.4 Create a Long Form of Data Set
```{r}
house_pwr_tidy <- house_pwr %>%
  gather(Meter, Watt_hr, `Sub-Meter-1`, `Sub-Meter-2`, `Sub-Meter-3`)  
```

```{r}
house_pwr_tidy$Meter <- factor(house_pwr_tidy$Meter)
glimpse(house_pwr_tidy)
```

##4 Explore the Data
###4.1 Visualizations of Energy Usage Across Sub-Meters and Time Periods
####4.1.1 Yearly Time Period
```{r cache=TRUE}
##-Year_Proportional Plot
house_pwr_tidy %>%
  filter(year(DateTime)>2006) %>%
  group_by(year(DateTime), Meter) %>%
  summarise(sum=sum(Watt_hr)) %>%
  ggplot(aes(x=factor(`year(DateTime)`), sum, group=Meter,fill=Meter)) +
  labs(x='Year', y='Proportion of Energy Useage') +
  ggtitle('Proportion of Total Yearly Energy Consumption') +
  geom_bar(stat='identity', position='fill', color='black')
```
```{r cache=TRUE}
##-Year_Line Plot
house_pwr_tidy %>%
  filter(year(DateTime)>2006) %>%
  group_by(year(DateTime), Meter) %>%
  summarise(sum=sum(Watt_hr/1000)) %>%
  ggplot(aes(x=factor(`year(DateTime)`), sum, group=Meter, colour=Meter)) +
  labs(x='Year', y='kWh') +
  ggtitle('Total Yearly Energy Consumption') +
  geom_line(size=1)
```
```{r cached=TRUE}
##-Year Bar Chart
house_pwr_tidy %>%
  filter(year(DateTime)>2006) %>%
  #mutate(year=year(DateTime)) %>%
  group_by(year(DateTime), Meter) %>%
  summarise(sum=round(sum(Watt_hr/1000),3)) %>%
  ggplot(aes(x=factor(`year(DateTime)`), y=sum)) +
  labs(x='Year', y='kWh') +
  ggtitle('Total Energy Useage by Year') +
  geom_bar(stat='identity', aes(fill = Meter), colour='black')
```
####4.1.2 Quarterly Time Period


```{r cached = TRUE}
#Quarter bar  plot
house_pwr_tidy %>%
  filter(year(DateTime)>2006) %>%
  #filter(year(DateTime)<2010) %>%
  #mutate(quarter=quarter(DateTime)) %>%
  group_by(quarter(DateTime), Meter) %>%
  summarise(sum=round(sum(Watt_hr/1000),3)) %>%
  ggplot(aes(x=factor(`quarter(DateTime)`), y=sum)) +
  labs(x='Quarter of the Year', y='Wh') +
  ggtitle('Total Quarterly Energy Consumption') +
  geom_bar(stat='identity', aes(fill = Meter), color='black')
```

####4.1.3 Monthly Time Period


```{r cached=TRUE}
###-Month- Line Plot
house_pwr_tidy %>%
  filter(year(DateTime)>2006) %>%
  mutate(Month=lubridate::month(DateTime, label=TRUE, abbr=TRUE)) %>%
  group_by(Month, Meter) %>%
  summarise(sum=sum(Watt_hr/1000)) %>%
  ggplot(aes(x=factor(Month), sum, group=Meter, colour=Meter)) +
  labs(x='Month of the Year', y='Wh') +
  ggtitle('Average Monthly Energy Useage') +
  geom_line(size=1) +
  geom_line()
```

```{r echo=TRUE, cached=TRUE}
###-Month bar chart
house_pwr_tidy %>%
  filter(year(DateTime)>2006) %>%
  #filter(year(DateTime)<2010) %>%
  mutate(Month=lubridate::month(DateTime, label=TRUE, abbr=TRUE)) %>%
  group_by(Month, Meter) %>%
  summarise(sum=round(sum(Watt_hr)/1000),3) %>%
  ggplot(aes(x=factor(Month), y=sum)) +
  labs(x='Month of the Year', y='kWh') +
  ggtitle('Total Energy Useage by Month of the Year') +
  geom_bar(stat='identity', aes(fill = Meter), colour='black')
```
####4.1.4 Week of the Year Time Period

```{r cached=TRUE}
#Week of the year- line plot
house_pwr_tidy %>%
  filter(year(DateTime)>2006) %>%
  group_by(week(DateTime), Meter) %>%
  summarise(sum=round(sum(Watt_hr)/1000),3) %>%
  ggplot(aes(x=factor(`week(DateTime)`), sum, group=Meter,colour=Meter)) +
  labs(x='Week of the Year', y='kWh') +
  ggtitle('Total Energy Usage by Week of the Year') +
  theme(axis.text.x = element_text(angle=90)) +
  geom_line(size=1) +
  geom_line()
```
```{r cached=TRUE}
#Week of the year- bar plot
house_pwr_tidy %>%
  #filter(year(DateTime)>2006) %>%
  group_by(week(DateTime), Meter) %>%
  summarise(sum=sum(Watt_hr/1000)) %>%
  ggplot(aes(x=factor(`week(DateTime)`), y=sum)) +
  labs(x='Week of the Year', y='kWh') +
  ggtitle('Total Energy Usage by Week of the Year') +
  theme(axis.text.x = element_text(angle=90)) +
  geom_bar(stat='identity', aes(fill=Meter), colour='black')

```
####4.1.5 Day of the Week Time Period
```{r cached = TRUE}
###-Day of Week- Porportional Plot
house_pwr_tidy %>%
  filter(year(DateTime)>2006) %>%
  mutate(Day=lubridate::wday(DateTime, label=TRUE, abbr=TRUE)) %>%
  group_by(Day, Meter) %>%
  summarise(sum=sum(Watt_hr/1000)) %>%
  ggplot(aes(x=factor(Day), sum, group=Meter,fill=Meter)) +
  labs(x='Day of the Week', y='Proportion of Energy Useage') +
  ggtitle('Proportion of Total Daily Energy Consumption') +
  geom_bar(stat='identity', position='fill', color='black')
```

```{r cached=TRUE}
###-Day of Week- Line Plot
house_pwr_tidy %>%
  filter(year(DateTime)>2006) %>%
  mutate(Day=lubridate::wday(DateTime, label=TRUE, abbr=TRUE)) %>%
  group_by(Day, Meter) %>%
  summarise(sum=sum(Watt_hr/1000)) %>%
  ggplot(aes(x=factor(Day), sum, group=Meter, colour=Meter)) +
  labs(x='Day of the Week', y='Wh') +
  ggtitle('Average Daily Energy Consumption') +
  geom_line(size=1) +
  geom_line()

```

```{r cached=TRUE}
###-Day of Week bar chart
house_pwr_tidy %>%
  filter(year(DateTime)>2006) %>%
  mutate(Day=lubridate::wday(DateTime, label=TRUE, abbr=TRUE)) %>%
  group_by(Day, Meter) %>%
  summarise(sum=sum(Watt_hr/1000)) %>%
  ggplot(aes(x=factor(Day), y=sum)) +
  labs(x='Day of the Week', y='kWh') +
  ggtitle('Total Energy Useage by Day of Week') +
  geom_bar(stat='identity', aes(fill = Meter), colour='black')

```
####4.1.7 Hour of the Day Time Period

```{r cached=TRUE}
###-Hour of the Day-Line Plot
house_pwr_tidy %>%
  filter(year(DateTime)>2006) %>%
  group_by(hour(DateTime), Meter) %>%
  summarise(sum=round(mean(Watt_hr), 3)) %>%
  ggplot(aes(x=factor(`hour(DateTime)`), sum, group=Meter,colour=Meter)) +
  labs(x='Hour of the Day', y='Wh') +
  ggtitle('Average Hourly Energy Consumption') +
  geom_line(size=1) +
  geom_line()
```

```{r cached=TRUE}
#Hour of day bar chart
house_pwr_tidy %>%
  filter(year(DateTime)>2006) %>%
  group_by(hour(DateTime), Meter) %>%
  summarise(sum=round(sum(Watt_hr)/1000),3) %>%
  ggplot(aes(x=factor(`hour(DateTime)`), y=sum)) +
  labs(x='Hour of the Day', y='kWh') +
  ggtitle('Total Energy Useage by Hour of the Day') +
  geom_bar(stat='identity', aes(fill = Meter), colour='black')
```
##5 Subset Data Set by Time Periods of Interest
###5.1 Quarterly 
Subset by Quarter
```{r}
housePWR_qtr <- house_pwr %>%
  filter(year(DateTime) > 2006) %>%
  #filter(year(DateTime)<2010) %>%
  group_by(year(DateTime), quarter(DateTime)) %>%
  summarise(Sub_Meter_1=round(sum(`Sub-Meter-1`/1000, na.rm=TRUE), 3),
            Sub_Meter_2=round(sum(`Sub-Meter-2`/1000, na.rm=TRUE), 3),
            Sub_Meter_3=round(sum(`Sub-Meter-3`/1000, na.rm=TRUE), 3),
            first_DateTime = first(DateTime))
```
###5.2 Monthly 
```{r}
housePWR_mnth <- house_pwr %>%
  #filter(year(DateTime) > 2006) %>%
  #filter(year(DateTime)<2011) %>%
  group_by(year(DateTime), month(DateTime)) %>%
  summarise(Sub_Meter_1=round(sum(`Sub-Meter-1`/1000, na.rm=TRUE), 3),
            Sub_Meter_2=round(sum(`Sub-Meter-2`/1000, na.rm=TRUE), 3),
            Sub_Meter_3=round(sum(`Sub-Meter-3`/1000, na.rm=TRUE), 3),
            first_DateTime = first(DateTime))
```
###5.3 Weekly
```{r}
housePWR_wkofYr <- house_pwr %>%
  #filter(year(DateTime)>2006) %>%
  #filter(year(DateTime)<2010) %>%
  mutate(DofWk=lubridate::wday(DateTime, label=TRUE, abbr=TRUE)) %>%
  group_by(year(DateTime),week(DateTime)) %>%
  summarise(Sub_Meter_1=round(sum(`Sub-Meter-1`/1000, na.rm=TRUE), 3),
            Sub_Meter_2=round(sum(`Sub-Meter-2`/1000, na.rm=TRUE), 3),
            Sub_Meter_3=round(sum(`Sub-Meter-3`/1000, na.rm=TRUE), 3),
            first_DateTime = first(DateTime))

```
###5.4 Day of Week
```{r}
housePWR_dofWk <- house_pwr %>%
  filter(year(DateTime)>2006) %>%
  #filter(year(DateTime)<2010) %>%
  mutate(DofWk=lubridate::wday(DateTime, label=TRUE, abbr=TRUE)) %>%
  group_by(week(DateTime),DofWk) %>%
  summarise(Sub_Meter_1=round(sum(`Sub-Meter-1`/1000, na.rm=TRUE), 3),
            Sub_Meter_2=round(sum(`Sub-Meter-2`/1000, na.rm=TRUE), 3),
            Sub_Meter_3=round(sum(`Sub-Meter-3`/1000, na.rm=TRUE), 3),
            first_DateTime = first(DateTime))
```
###5.5 Hour of the Day
```{r}
housePWR_hofDay <- house_pwr %>%
  filter(year(DateTime)>2006) %>%
  #filter((minute(DateTime) %% 5) == 0) %>%
  group_by(wday(DateTime), hour(DateTime)) %>%
  summarise(Sub_Meter_1=round(sum(`Sub-Meter-1`/1000, na.rm=TRUE), 3),
            Sub_Meter_2=round(sum(`Sub-Meter-2`/1000, na.rm=TRUE), 3),
            Sub_Meter_3=round(sum(`Sub-Meter-3`/1000, na.rm=TRUE), 3),
            first_DateTime = first(DateTime))

```
##6 Convert to Time Series and Plot TS
###6.1 Quarterly Time Series
```{r}
housePWR_qtrTS <- ts(housePWR_qtr[,3:5], frequency=4, start=c(2007,1), end=c(2010,3))
plot(housePWR_qtrTS, plot.type='s',
     #xaxt='n',
     #xlim=c(2007, 2010),
     #xaxp=c(2006, 2011, 5),
     col=c('red', 'green', 'blue'),
     main='Total Quarterly kWh Consumption',
     xlab='Year', ylab = 'kWh')
minor.tick(nx=4)
b <- c('Sub-meter-1', 'Sub-meter-2', 'Sub-meter-3')
legend('topleft', b, col=c('red', 'green', 'blue'), lwd=2, bty='n')
```
###6.2 Monthly Time Series
```{r}
housePWR_mnthTS <- ts(housePWR_mnth[,3:5], frequency = 12, start=c(2007,1), end=c(2010,11))
plot(housePWR_mnthTS, plot.type='s',#xaxt='n',
     #xaxp = c(1,13,12),
     col=c('red', 'green', 'blue'),
     main='Total Monthly kWh Consumption',
     xlab='Year/Month', ylab = 'kWh')
minor.tick(nx=12)
b <- c('Sub-meter-1', 'Sub-meter-2', 'Sub-meter-3')
legend('topleft', b, col=c('red', 'green', 'blue'), lwd=2, bty='n')
```
###6.3 Week of the Year Time Series
```{r}
housePWR_wkofYrTS <- ts(housePWR_wkofYr[,3:5], frequency =53, start=c(2006,51), end=c(2010,47))
plot(housePWR_wkofYrTS, plot.type='s', #xaxt='n',
     #xaxp = c(1, 13, 12),
     col=c('red', 'green', 'blue'),
     xlab ='Year', ylab = 'kWh',
     #ylim=c(0,120),
     main='Total Energy Consumption by Week of the Year')
#axis(side=1, at= c(1, 2,3,4,5,6,7,8,9,10,11,12,13), labels=MonthLst)
minor.tick(nx=52)
b <- c('Sub-meter-1', 'Sub-meter-2', 'Sub-meter-3')
legend('topleft', b, col=c('red', 'green', 'blue'), lwd=2, bty='n')
```
###6.4 Day of the Week Time Series
```{r}
housePWR_hofDayTS <- ts(housePWR_hofDay[,3:5], frequency=24, start=c(0,0))
plot(housePWR_hofDayTS, plot.type='s',
     #xaxp = c(0,48, 47),
     col=c('red', 'green', 'blue'),
     xlab='Day', ylab = 'kWh',
     main='Total kWh Consumption by Hour of the Day')
minor.tick(nx=24)
b <- c('Sub-meter-1', 'Sub-meter-2', 'Sub-meter-3')
legend('topleft', b, col=c('red', 'green', 'blue'), lwd=2, bty='n')
```
##7 Forecasts of Energy Consumption_Linear Model
###7.1 Quarterly Forecast
```{r}
fit1 <- tslm(housePWR_qtrTS[,3] ~ trend + season)
x <- forecast(fit1, h=4, level=c(80,95))
plot(x, showgap=FALSE, include=3,
     shadecols=c('slategray3','slategray'),
     xlab='Year', ylab='kWh',
     main='4-Quarter Forecast of Quartlerly Energy Consumption for Submeter-3')
minor.tick(nx=2)
summary(x)
```
```{r}
plot.ts(x=fit1$fitted.values, y=housePWR_qtrTS[,3], xy.lines = FALSE,
        xy.labels = FALSE,
        xlab='Fitted Value',
        ylab='Actual',
        main='Quarterly Predicted vs. Actual Values')
abline(0,1, col='blue')

```

```{r}
plot.ts(x=fit1$fitted.values, y=fit1$residuals, xy.lines=FALSE,
        xy.labels = FALSE,
        xlab='Predicted Value',
        ylab='Residuals',
        main='Quarterly Predicted vs. Residuals')
abline(0,0, lty=2, col='grey')
```

```{r}
qqnorm(fit1$residuals, main='Quarterly Q-Q Plot')
qqline(fit1$residuals)
```
 
```{r}
checkresiduals(fit1)

```
###7.2 Monthly Forecast
```{r}
fit2 <- tslm(housePWR_mnthTS[,3] ~ trend + season)
y <- forecast(fit2,h=12, level=c(80,95))
plot(y, showgap=FALSE, include=5,
  shadecols=c('slategray3','slategray'),
  xlab ='Year',
  ylab=' kWh',
  main='12-Month Forecast of Monthly Energy Consumption')
minor.tick(nx=6)
```
```{r}
plot.ts(x=fit2$fitted.values, y=housePWR_mnthTS[,3], xy.lines = FALSE,
        xy.labels = FALSE,
        xlab='Fitted Value',
        ylab='Actual',
        main='Monthly Predicted vs. Actual Values')
abline(0,1, col='blue')
```

```{r}
plot.ts(x=fit2$fitted.values, y=fit2$residuals, xy.lines=FALSE,
        xy.labels = FALSE,
        xlab='Predicted Value',
        ylab='Residuals',
        main='Monthly Predicted vs. Residuals')
abline(0,0, lty=2, col='grey')
```
```{r}
qqnorm(fit2$residuals, main='Monthly Q-Q Plot')
qqline(fit2$residuals)

```
```{r}
checkresiduals(fit2)

```
```{r}
fit3 <- tslm(housePWR_wkofYrTS[,3] ~ trend + season)
z <- forecast(fit3, level=c(80,95), h=24)
plot(z, showgap=FALSE, include=8,
     shadecols=c('slategray3','slategray'),
     xlab ='Year',
     ylab='kWh',
     main='24-Week Forecast of Weekly Energy Consumption on Submeter-3')
```
```{r}
plot.ts(x=fit3$fitted.values, y=housePWR_wkofYrTS[,3], xy.lines = FALSE,
        xy.labels = FALSE,
        xlab='Fitted Value',
        ylab='Actual',
        main='Week of Year Predicted vs. Actual Values')
abline(0,1, col='blue')
```
```{r}
plot.ts(x=fit3$fitted.values, y=fit3$residuals, xy.lines=FALSE,
        xy.labels = FALSE,
        xlab='Predicted Values',
        ylab='Residuals',
        main='Week of Year Predicted vs. Residuals')
abline(0,0, lty=2, col='grey')
```
```{r}
qqnorm(fit3$residuals, main='Weekly Q-Q Plot')
qqline(fit3$residuals)
```
```{r}
checkresiduals(fit3, main='Residuals from Week of Year Linear Regression Model')

```
##8 Holt-Winters Simple Exponential Smoothing Model
###8.1 Quarterly Time Series
```{r}
##-Sub-Meter-3
#-Decompose TS
qtr_decomp3 <- decompose(housePWR_qtrTS[,3])
autoplot(qtr_decomp3,  range.bars = TRUE) +
  xlab('Year') +
  ylab('kWh') +
  ggtitle('Decomposed Quarterly Time Series- Sub-Meter-3')
```
```{r}
#-remove seasonality
qtr_seasonAdj3 <- seasadj(qtr_decomp3)

plot(qtr_seasonAdj3, #xaxt='n',
     col='blue',
     xlab='Year', ylab='kWh',
     #xlim=c(2007, 2010),
     xaxp=c(2006, 2010, 4),
     main='Seasonally Adjusted Quarterly Time Series')
minor.tick(nx=2)
b <-'Sub-meter-3'
legend('topleft', b, col='blue', lwd=2, bty='n')
```

```{r}
#-Fit Holt Winters simple exponetial smoothing model
qtr_smooth3 <- HoltWinters(qtr_seasonAdj3,
                           beta=FALSE,
                           gamma=FALSE)
plot(qtr_smooth3, col='blue', #xaxt='n',
     xlab='Year', ylab = 'kWh',
     xlim=c(2007, 2011),
     xaxp=c(2006, 2010, 4),
     main='Simple Exponential Smoothing Holt-Winters Model for Quarterly Time Series')
minor.tick(nx=4)
legend('topleft', 'Sub-Meter-3', col='blue', lwd=2, bty='n')
```

```{r}
#-Forecast
qtr_smoothFcast3 <- forecast(qtr_smooth3, h=5,level = c(80,95))

#summary(qtr_smoothFcast3)
checkresiduals(qtr_smoothFcast3)
plot(qtr_smoothFcast3, include=1,
     #xaxt='n',
     shadecols=c('slategray3','slategray'),
     col='blue',
     #xaxp=c(2010.6,2011.5,4),
     xlab='Year', ylab = 'Wh',
     #xlim=c(2010,2011),
     main='5 Quarter Forecast of Energy Useage on Sub-Meter 3')
#minor.tick(nx=4)
#axis(side=1, at= c(1, 2,3,4,5,6,7,8,9,10,11,12, 13), labels=MonthLst)
legend('topleft', 'Sub-Meter-3', col='blue', lwd=2, bty='n')
```





